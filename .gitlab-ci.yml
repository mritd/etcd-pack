stages:
  - build
  - release

variables:
  VERSION: ""

.build:
  stage: build
  image: ubuntu:24.04
  before_script:
    - apt-get update && apt-get install -y curl jq
    - sh -c "$(curl -fsSL https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin
    - curl -fsSL https://repo.goreleaser.com/apt/gpg.key | gpg --dearmor -o /usr/share/keyrings/goreleaser.gpg
    - echo "deb [signed-by=/usr/share/keyrings/goreleaser.gpg] https://repo.goreleaser.com/apt/ /" > /etc/apt/sources.list.d/goreleaser.list
    - apt-get update && apt-get install -y nfpm
  artifacts:
    paths:
      - dist/packages/*

build:amd64:
  extends: .build
  script:
    - task build ARCHS=amd64

build:arm64:
  extends: .build
  script:
    - task build ARCHS=arm64

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - build:amd64
    - build:arm64
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "etcd $CI_COMMIT_TAG"
    description: "etcd packages for $CI_COMMIT_TAG"
    assets:
      links:
        - name: "etcd-${CI_COMMIT_TAG}-amd64.deb"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/packages/etcd_${CI_COMMIT_TAG}_amd64.deb"
        - name: "etcd-${CI_COMMIT_TAG}-arm64.deb"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/packages/etcd_${CI_COMMIT_TAG}_arm64.deb"
  rules:
    - if: $CI_COMMIT_TAG
